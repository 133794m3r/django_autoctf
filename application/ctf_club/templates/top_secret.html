{% extends "layout.html" %}
{% load static %}
{% block head %}
	<link rel="stylesheet" href="/static/js/cm/lib/codemirror.css"  />
	<link rel="stylesheet" href="/static/js/cm/theme/3024-night.css"  />
	<link rel="stylesheet" href="/static/js/cm/addon/fold/foldgutter.css" />
	<script src="/static/js/require.js" type="text/javascript"></script>
	{#<script src="/static/js/vs/loader.js"></script>#}
	<script type="text/javascript">
	editor = {}
	//GLOBAL VARIABLES
	// the languages that the challenge supports. Will be downloaded from the server once the base-codes are downloaded for
	// this specific challenge. This data will be updated programmatically via the templating engine eventually.
	LANGS = ['python','javascript']
	//
	BASE_CODES = {'python':`import sys #basic import ignore this\ndef fizzbuzz(max_number):\n\t#write your code here based upon instructions.\n\tpass\n\n#ignore all code below here. Only edit fizzbuzz function.\nresults = []\n\nfor num in sys.argv[1:]:\n\tresults.append(fizzbuzz(num))\nprint('\\n'.join(results))`,
		 'javascript':`const process = require('process')\nlet args = process.argv.slice(1,)\nlet results = []\nfor(let num : args){\n\tresults.append(fizzBuzz(maxNumber))\n}\n\nconsole.log(results.join('\\n'))\n\n//only edit this function ingore all code above it\nfunction fizzBuzz(maxNumber){\n\n}`}

	document.addEventListener("DOMContentLoaded",()=>{
		document.getElementById("submit_chal").addEventListener("click",event=>{submit_chal()});
		editor.foldCode(CodeMirror.pos(9,0));
	});
	function submit_chal(){
		let el = document.getElementById("language");
		let lang = parseInt(el.options[el.selectedIndex].value);
	   let code = editor.getValue();
		if(lang === -1){
			return;
		}
		submit('/top_secret_test',{'code':code,'language':lang},resp=>{
			console.log(resp)
			document.getElementById('final_score').innerText = resp.score;
		});
	}

	require.config({
		paths:{
			'cm':'/static/js/cm',
		}
	});
	//	 require.config({"paths":{cm:"/static/js/cm"}})

	require(["cm/lib/codemirror",
		"cm/mode/python/python", "cm/mode/javascript/javascript", "cm/addon/edit/matchbrackets", "cm/addon/edit/closebrackets",
			  "cm/addon/fold/foldcode", "cm/addon/fold/foldgutter", "cm/addon/fold/brace-fold","cm/addon/fold/comment-fold",
		 ],
	function() {
		let lang = 'javascript';
		console.log(BASE_CODES[lang])
		CodeMirror = arguments[0]
	   editor = CodeMirror(document.getElementById('container'), {
		   value: `${BASE_CODES[lang]}`,
		   mode: lang,
		   theme: '3024-night',
		   lineNumbers: true,
		   foldGutter: true,
		   gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
		   extraKeys: {
			   "Ctrl-Q": function (cm) {
				   cm.foldCode(cm.getCursor());
			   }
		   },
	   })
	   }
   )

   /**
	 * Visual Studo Code's Monaco Editor are being used. Place the vs folder into static/js folder.
	 * Not committing the files into the tree as they're far too large at this time.
	 */
   /*
   require.config({paths:{vs:'/static/js/vs'}})
	require(['vs/editor/editor.main'], function () {
				editor = monaco.editor.create(document.getElementById('container'), {
					value: BASE_CODES['javascript'],
					language: 'javascript',
					 theme:'vs-dark',
				});
	});
*/

   /**
	 * Updates the base code/langauge for the Editor context
	* @param element
	*/
/*
   var cm = CodeMirror.fromTextArea(document.getElementById('container'),{
	   value:LANGS['python'],
	   mode:'python',
	   theme:'3023-night.css',
	   lineNumbers: true,
	   lineWrapping: true,
	   foldGutter:true,
	   gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
	   extraKeys: {"Ctrl-Q": function(cm){ cm.foldCode(cm.getCursor()); }},
   })
*/
   function update_language(element){
		if(element.value === -1)
			return;

		 let lang = LANGS[element.value];

		//monaco.editor.setModelLanguage(editor.getModel(),lang);
		//editor.setValue(BASE_CODES[lang]);
		 //cm.setOption('mode',lang)
		 //cm.setValue(BASE_CODES[lang])
		 editor.options.mode = lang;
		 editor.doc.setValue(BASE_CODES[lang])
	}


</script>

{% endblock %}

{% block body %}
	<main role="main" class="col-lg">
		<div class="row mb-3">
			<div style="width:30%;">
				<select id="language" onchange="update_language(this);">
					<option value="-1">Language</option>
					<option value="0">Python</option>
					<option value="1">JavaScript</option>
				</select>
				<input type="button" class="btn-dark" id="submit_chal" value="Submit Try"/>
			</div>
			<div id="container" class="vh-75" style="width:70%;">
			</div>
		</div>
		<div class="row">
			<div class="col">
				<div class="card">
					<div class="card-header">Test Results</div>
					<div class="card-body">Test #1</div>
				</div>
			</div>
		</div>
	</main>
{% endblock %}